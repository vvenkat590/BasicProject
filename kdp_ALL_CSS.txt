select AdminDept,LineDept,state,central,OB,SA,fdsum,state_release_amount,central_release_amount,fintarget_upto_prev,fintarget_curr,fintarget_upto_curr,finprogress_upto_prev,finprogress_curr,finprogress_upto_curr,monthly_target,cum_target,tot_alloc,COALESCE(prevTAASum,0) prevTAASum,
COALESCE(prevPROGSum,0) prevPROGSum,COALESCE(prev_total_alloc,0) prev_total_alloc,curr.departmentcode,curr.group_dept from
(
select d.dept_english as AdminDept,'test' as LineDept,COALESCE(sum(state),0) state,COALESCE(sum(central),0) central,COALESCE(sum(OB),0) OB, COALESCE(sum(SA),0) SA,COALESCE(sum(TAA),0) as fdsum, 
COALESCE(sum(state_release_amount),0) state_release_amount, COALESCE(sum(central_release_amount),0) central_release_amount, COALESCE(sum(fintarget_upto_prev) ,0) as fintarget_upto_prev, COALESCE(sum(fintarget_curr),0) as fintarget_curr,COALESCE(sum(fintarget_upto_curr) ,0) as fintarget_upto_curr,
 COALESCE(sum(finprogress_upto_prev),0) as finprogress_upto_prev, COALESCE(sum(finprogress_curr),0) as finprogress_curr, COALESCE(sum(finprogress_upto_curr),0) as finprogress_upto_curr,(nvl(ROUND((sum(finprogress_curr) *100/nullif(sum(fintarget_curr),0)),2),0)) monthly_target, 
 (nvl(ROUND((sum(finprogress_upto_curr) *100/nullif(sum(fintarget_upto_curr),0)),2),0)) cum_target, (nvl(ROUND((sum(finprogress_upto_curr) *100/nullif(sum(TAA),0)),2),0)) tot_alloc, ct.departmentcode,ct.group_dept
from( select fin.dept_eng,fin.scheme,fin.state,fin.central,fin.OB,fin.SA,fin.TAA,budrel.state_release_amount,budrel.central_release_amount, fin.fintarget_upto_prev, fin.fintarget_curr,fin.fintarget_upto_curr, fin.finprogress_upto_prev,fin.finprogress_curr,fin.finprogress_upto_curr, 
fin.departmentcode,fin.departmentline,fin.group_dept, fin.line_dept from( select grandtotal.dept_eng as dept_eng,grandtotal.scheme,grandtotal.state,grandtotal.central,grandtotal.OB,grandtotal.SA,grandtotal.TAA, target.fintarget_upto_prev, target.fintarget_curr,target.fintarget_upto_curr, 
target.finprogress_upto_prev,target.finprogress_curr, target.finprogress_upto_curr, grandtotal.departmentcode,grandtotal.departmentline,grandtotal.group_dept, grandtotal.line_dept from
( select dep.dept_eng,fd.scheme,fd.state,fd.central,fd.OB,fd.SA,fd.TAA,dep.departmentcode,dep.departmentline, 
dep.group_dept, dep.line_dept from( select d.dept_english as dept_eng, fd.departmentcode,fd.departmentline, d.group_dept, d.line_dept from misdss.mm_fd_allotment fd, misdss.mm_department d where fd.departmentcode != fd.departmentline and fd.departmentline != '0.0' and fd.departmentcode = d.dept_code 
and fd.departmentline = d.dept_line_code and fd.plan_nonplan_status='P' and fd.fin_year='2019-2020'   group by d.group_dept, d.line_dept, fd.departmentcode, fd.departmentline, d.dept_english UNION  select d.dept_english as dept_eng, fd.departmentcode,fd.departmentline, d.group_dept, d.line_dept from 
misdss.mm_zp_tp_fd_allotment fd, misdss.mm_department d where fd.departmentcode != fd.departmentline and fd.departmentline != '0.0' and fd.departmentcode = d.dept_code and fd.departmentline = d.dept_line_code and fd.plan_nonplan_status='P' and fd.fin_year='2019-2020'   group by d.group_dept, d.line_dept, 
fd.departmentcode, fd.departmentline, d.dept_english
)dep LEFT OUTER JOIN 
( select t.scheme,sum(state)state,sum(central)central,sum(OB)OB,sum(SA)SA,sum(TAA)TAA,t.departmentcode,t.departmentline from( select fdm.major_head||'-'||fdm.submajor_head||'-'||fdm.minor_head||'-'||fdm.group_subhead||'-'||fdm.sub_head||'-'||fdm.detailed_head scheme, sum(fdm.state_amount) as state,
sum(fdm.central_amount) as central,sum(fdm.opening_balance) as OB,sum(fdm.supplementary_grant) as SA, sum(fdm.amount) as TAA, fdm.departmentcode,fdm.departmentline from misdss.mm_fd_allotment fdm where  fdm.fin_year='2019-2020' and (fdm.central_amount!='0' or fdm.state_amount!='0') and fdm.plan_nonplan_status='P' 
and fdm.departmentcode != fdm.departmentline and  fdm.departmentcode > '0' and fdm.departmentline > '0.0' group by fdm.departmentcode,fdm.departmentline,scheme union all select fdm.major_head||'-'||fdm.submajor_head||'-'||fdm.minor_head||'-'||fdm.group_subhead||'-'||fdm.sub_head||'-'||fdm.detailed_head scheme, 
sum(fdm.state_amount) as state,sum(fdm.cs_amount) as central,sum(fdm.opening_balance) as OB,sum(fdm.supplementary_grant) as SA, sum(fdm.amount) as TAA, fdm.departmentcode,fdm.departmentline from misdss.mm_zp_tp_fd_allotment fdm where  fdm.fin_year='2019-2020' and (fdm.cs_amount!='0' or fdm.state_amount!='0') and 
fdm.plan_nonplan_status='P' and fdm.departmentcode != fdm.departmentline and  fdm.departmentcode > '0' and fdm.departmentline > '0.0' group by fdm.departmentcode,fdm.departmentline,scheme )t group by t.departmentcode ,t.departmentline,t.scheme)fd on dep.departmentcode=fd.departmentcode and dep.departmentline=fd.departmentline
)grandtotal LEFT OUTER JOIN 
(
 select t.scheme,sum(fintarget_upto_prev)fintarget_upto_prev,sum(fintarget_curr)fintarget_curr,sum(fintarget_upto_curr)fintarget_upto_curr, sum(finprogress_upto_prev)finprogress_upto_prev,sum(finprogress_curr)finprogress_curr,sum(finprogress_upto_curr)finprogress_upto_curr,t.dept_code,t.dept_line_code from( 
 select mp.major_head||'-'||mp.submajor_head||'-'||mp.minor_head||'-'||mp.group_subhead||'-'||mp.sub_head||'-'||mp.detailed_head scheme, sum(case when mp.financial_target > 0 AND to_number(mp.month) <= '2' then mp.financial_target else 0 end) fintarget_upto_prev, sum(case when mp.financial_target > 0 AND to_number(mp.month) = '3' 
 then mp.financial_target else 0 end) fintarget_curr, sum(case when mp.financial_target > 0 AND to_number(mp.month) <= '3' then mp.financial_target else 0 end) fintarget_upto_curr, sum(case when (mp.FINANCIAL_PROGRESS > 0 AND to_number(mp.month) <= '2'  and mp.approval_flag NOT LIKE 'R-%')  then mp.financial_progress else 0 end) finprogress_upto_prev, 
 sum(case when (mp.FINANCIAL_PROGRESS > 0 AND to_number(mp.month) = '3'  and mp.approval_flag NOT LIKE 'R-%')  then mp.financial_progress else 0 end) finprogress_curr, sum(case when (mp.FINANCIAL_PROGRESS > 0 AND to_number(mp.month) <= '3'  and mp.approval_flag NOT LIKE 'R-%')  then mp.financial_progress else 0 end) finprogress_upto_curr, mp.dept_code,mp.dept_line_code 
 from misdss.td_mpic mp where  mp.fin_year='2019-2020' and mp.plan_nonplan_status='P' group by mp.dept_code,mp.dept_line_code,scheme union all select mp.major_head||'-'||mp.submajor_head||'-'||mp.minor_head||'-'||mp.group_subhead||'-'||mp.sub_head||'-'||mp.detailed_head scheme, sum(case when mp.financial_target > 0 AND to_number(mp.month) <= '2' then mp.financial_target else 0 end) fintarget_upto_prev,
 sum(case when mp.financial_target > 0 AND to_number(mp.month) = '3' then mp.financial_target else 0 end) fintarget_curr, sum(case when mp.financial_target > 0 AND to_number(mp.month) <= '3' then mp.financial_target else 0 end) fintarget_upto_curr, sum(case when (mp.FINANCIAL_PROGRESS > 0 AND to_number(mp.month) <= '2'  and mp.approval_flag NOT LIKE 'R-%')  then mp.financial_progress else 0 end) finprogress_upto_prev,
 sum(case when (mp.FINANCIAL_PROGRESS > 0 AND to_number(mp.month) = '3'  and mp.approval_flag NOT LIKE 'R-%')  then mp.financial_progress else 0 end) finprogress_curr, sum(case when (mp.FINANCIAL_PROGRESS > 0 AND to_number(mp.month) <= '3'  and mp.approval_flag NOT LIKE 'R-%')  then mp.financial_progress else 0 end) finprogress_upto_curr, mp.link_dept_code dept_code
,mp.link_dept_line dept_line_code from misdss.mm_zp_td_mpic mp where  mp.fin_year='2019-2020' and mp.plan_nonplan_status='P' group by mp.link_dept_code,mp.link_dept_line,scheme )t group by t.scheme,t.dept_code,t.dept_line_code )target on grandtotal.departmentcode=target.dept_code and grandtotal.departmentline=target.dept_line_code  and grandtotal.scheme=target.scheme 
)fin LEFT OUTER JOIN(
 select sum(state_release_amount)state_release_amount,sum(central_release_amount)central_release_amount,t.scheme,t.dept_code,t.dept_line_code FROM( select round(v1.state_release_amount) state_release_amount,round(v1.central_release_amount) central_release_amount,v1.scheme,v1.dept_code,v1.dept_line_code from ( select sum(case when (a.cut_release_amount) > 0 and a.go_number!='CGOSHA2018' and a.release_type='G' then 
 a.cut_release_amount else 0 END) state_release_amount, sum(case when (a.cut_release_amount) > 0 and (a.go_number like 'CGOSHA2018') then a.cut_release_amount else 0 END) central_release_amount, a.major_head||'-'||a.submajor_head||'-'||a.minor_head||'-'||a.group_subhead||'-'||a.sub_head||'-'||a.detailed_head as scheme,a.dept_code,a.dept_line_code from  misdss.budget_release a where  a.auth_ddo_code = a.ddo_code and 
 a.release_mode ='D' and a.sector='1' and a.fin_year='2019-2020' group by scheme,a.dept_code,a.dept_line_code order by scheme)v1 union ALL select round(v1.state_release_amount) state_release_amount,round(v1.central_release_amount) central_release_amount,v1.scheme,v1.dept_code,v1.dept_line_code from ( select sum(case when (a.cut_release_amount) > 0 and a.go_number!='CGOSHA2018' and a.release_type='G' then a.cut_release_amount else 0 END) state_release_amount, 
 sum(case when (a.cut_release_amount) > 0 and (a.go_number like 'CGOSHA2018') then a.cut_release_amount else 0 END) central_release_amount, a.major_head||'-'||a.submajor_head||'-'||a.minor_head||'-'||a.group_subhead||'-'||a.sub_head||'-'||a.detailed_head as scheme,a.link_dept_code dept_code,a.link_dept_line dept_line_code from  misdss.mm_zp_budget_release a where  a.auth_ddo_code = a.ddo_code and a.release_mode ='D' and a.sector='2' 
 and a.fin_year='2019-2020' group by scheme,a.link_dept_code,a.link_dept_line  order by scheme)v1 )t group by t.scheme,t.dept_code,t.dept_line_code )budrel on fin.scheme=budrel.scheme and fin.departmentcode=budrel.dept_code and fin.departmentline=budrel.dept_line_code 
 )ct,misdss.mm_department d where ct.group_dept = d.group_dept and d.group_dept = d.line_dept and (ct.state!=0 or ct.central!=0) group by AdminDept,LineDept,ct.group_dept,ct.departmentcode
 )curr
 LEFT OUTER JOIN
 (
 select COALESCE(sum(prevTAA),0) as prevTAASum,COALESCE(sum(prevPROG),0) as prevPROGSum,(nvl(ROUND((sum(prevPROG) *100/nullif(sum(prevTAA),0)),2),0)) prev_total_alloc,
ct.departmentcode,ct.group_dept from
(
select fin.TAA as prevTAA ,fin.finprogress_upto_curr as prevPROG,fin.state,fin.central,fin.departmentcode,fin.departmentline, fin.group_dept, fin.line_dept from
(
 select grandtotal.scheme,grandtotal.state,grandtotal.central,grandtotal.TAA,target.finprogress_upto_curr, grandtotal.departmentcode,grandtotal.departmentline,grandtotal.group_dept, grandtotal.line_dept from
( select fd.scheme,fd.state,fd.central,fd.TAA,dep.departmentcode,dep.departmentline, 
dep.group_dept, dep.line_dept from( select d.dept_english as dept_eng, fd.departmentcode,fd.departmentline, d.group_dept, d.line_dept from misdss.mm_fd_allotment fd, misdss.mm_department d where fd.departmentcode != fd.departmentline and fd.departmentline != '0.0' and fd.departmentcode = d.dept_code 
and fd.departmentline = d.dept_line_code and fd.plan_nonplan_status='P' and fd.fin_year='2018-2019'   group by d.group_dept, d.line_dept, fd.departmentcode, fd.departmentline, d.dept_english UNION  select d.dept_english as dept_eng, fd.departmentcode,fd.departmentline, d.group_dept, d.line_dept from 
misdss.mm_zp_tp_fd_allotment fd, misdss.mm_department d where fd.departmentcode != fd.departmentline and fd.departmentline != '0.0' and fd.departmentcode = d.dept_code and fd.departmentline = d.dept_line_code and fd.plan_nonplan_status='P' and fd.fin_year='2018-2019'   group by d.group_dept, d.line_dept, 
fd.departmentcode, fd.departmentline, d.dept_english
)dep LEFT OUTER JOIN 
( select t.scheme,sum(state)state,sum(central)central,sum(TAA)TAA,t.departmentcode,t.departmentline from( select fdm.major_head||'-'||fdm.submajor_head||'-'||fdm.minor_head||'-'||fdm.group_subhead||'-'||fdm.sub_head||'-'||fdm.detailed_head scheme, sum(fdm.state_amount) as state,
sum(fdm.central_amount) as central, sum(fdm.amount) as TAA, fdm.departmentcode,fdm.departmentline from misdss.mm_fd_allotment fdm where  fdm.fin_year='2018-2019' and (fdm.central_amount!='0' or fdm.state_amount!='0') and fdm.plan_nonplan_status='P' 
and fdm.departmentcode != fdm.departmentline and  fdm.departmentcode > '0' and fdm.departmentline > '0.0' group by fdm.departmentcode,fdm.departmentline,scheme union all select fdm.major_head||'-'||fdm.submajor_head||'-'||fdm.minor_head||'-'||fdm.group_subhead||'-'||fdm.sub_head||'-'||fdm.detailed_head scheme, 
sum(fdm.state_amount) as state,sum(fdm.cs_amount) as central,sum(fdm.amount) as TAA, fdm.departmentcode,fdm.departmentline from misdss.mm_zp_tp_fd_allotment fdm where  fdm.fin_year='2018-2019' and (fdm.cs_amount!='0' or fdm.state_amount!='0') and 
fdm.plan_nonplan_status='P' and fdm.departmentcode != fdm.departmentline and  fdm.departmentcode > '0' and fdm.departmentline > '0.0' group by fdm.departmentcode,fdm.departmentline,scheme )t group by t.departmentcode ,t.departmentline,t.scheme)fd on dep.departmentcode=fd.departmentcode and dep.departmentline=fd.departmentline
)grandtotal LEFT OUTER JOIN 
(
 select t.scheme,sum(finprogress_upto_curr)finprogress_upto_curr,t.dept_code,t.dept_line_code from( 
 select mp.major_head||'-'||mp.submajor_head||'-'||mp.minor_head||'-'||mp.group_subhead||'-'||mp.sub_head||'-'||mp.detailed_head scheme, 
  sum(case when (mp.FINANCIAL_PROGRESS > 0 AND to_number(mp.month) <= '3'  and mp.approval_flag NOT LIKE 'R-%')  then mp.financial_progress else 0 end) finprogress_upto_curr, mp.dept_code,mp.dept_line_code 
 from misdss.td_mpic mp where  mp.fin_year='2018-2019' and mp.plan_nonplan_status='P' group by mp.dept_code,mp.dept_line_code,scheme union all select mp.major_head||'-'||mp.submajor_head||'-'||mp.minor_head||'-'||mp.group_subhead||'-'||mp.sub_head||'-'||mp.detailed_head scheme,
 sum(case when (mp.FINANCIAL_PROGRESS > 0 AND to_number(mp.month) <= '3'  and mp.approval_flag NOT LIKE 'R-%')  then mp.financial_progress else 0 end) finprogress_upto_curr, mp.link_dept_code dept_code
,mp.link_dept_line dept_line_code from misdss.mm_zp_td_mpic mp where  mp.fin_year='2018-2019' and mp.plan_nonplan_status='P' group by mp.link_dept_code,mp.link_dept_line,scheme )t group by t.scheme,t.dept_code,t.dept_line_code )target on grandtotal.departmentcode=target.dept_code and grandtotal.departmentline=target.dept_line_code  and grandtotal.scheme=target.scheme 
)fin
)ct,misdss.mm_department d where ct.group_dept = d.group_dept and d.group_dept = d.line_dept and (ct.state!=0 or ct.central!=0) group by ct.group_dept,ct.departmentcode

 )prev ON curr.departmentcode=prev.departmentcode and curr.group_dept=prev.group_dept order by cum_target  desc